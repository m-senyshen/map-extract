<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Map Extract — PDF→PNG (robust loader)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;text-align:center;color:#333;margin:0;padding:0}
    .hero{background:#f0f7ff;padding:64px 20px}
    .hero h1{font-size:40px;margin:0 0 12px}
    .hero p{max-width:680px;margin:0 auto 18px;font-size:18px}
    .upload-box{border:2px dashed #0077ff;border-radius:12px;padding:40px;max-width:420px;margin:18px auto;background:#f9fbff;transition:background .15s,border-color .15s}
    .upload-box.dragover{background:#e8f4ff;border-color:#005fcc}
    .upload-box p{color:#0077ff;margin:0 0 12px;font-size:17px}
    .file-label{display:inline-block;padding:10px 20px;background:#0077ff;color:#fff;border-radius:8px;cursor:pointer;font-size:16px}
    .file-label:hover{background:#005fcc}
    .processing-msg{color:#444;margin-top:12px}
    a.download-link{display:block;margin-top:14px}
    .error{color:#b00020;margin-top:12px}
    .footer{margin:48px 0 28px;color:#666;font-size:14px}
  </style>
</head>
<body>

  <section class="hero">
    <h1>Map Extract</h1>
    <p>Upload a map PDF — we render the first page to PNG in your browser (no server upload).</p>

    <div id="upload-box" class="upload-box" aria-label="Drop PDF here">
      <p>Drag & drop PDF here</p>
    </div>

    <!-- label triggers the hidden input natively -->
    <label for="pdf-upload" class="file-label">Select Your File</label>
    <input id="pdf-upload" type="file" accept="application/pdf" style="display:none">

    <div id="status" aria-live="polite"></div>
    <div id="error" class="error" role="alert"></div>
  </section>

  <section class="footer">
    <div>Map Extract — client-side demo</div>
  </section>

<script>
/*
  Robust loader + init:
  - Dynamically loads libs/pdf.min.js from ./libs/pdf.min.js
  - When loaded, sets workerSrc to ./libs/pdf.worker.min.js
  - If loading fails, prints actionable error
  - Then wires drag/drop and file input to render first page -> PNG
*/

/** CONFIG **/
const PDF_JS_PATH = 'libs/pdf.min.js';
const PDF_WORKER_PATH = 'libs/pdf.worker.min.js';
const SCRIPT_LOAD_TIMEOUT_MS = 6000; // fail if takes too long

/** helper to load a script and return a promise that resolves onload or rejects onerror/timeout */
function loadScript(src, timeoutMs = SCRIPT_LOAD_TIMEOUT_MS) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => { resolve(); };
    s.onerror = (ev) => { reject(new Error('Script failed to load: ' + src)); };
    document.head.appendChild(s);
    if (timeoutMs) {
      setTimeout(() => reject(new Error('Timed out loading script: ' + src)), timeoutMs);
    }
  });
}

/** show messages to user */
const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
function setStatus(msg){ statusEl.textContent = msg; }
function clearStatus(){ statusEl.textContent = ''; }
function setError(msg){ errorEl.textContent = msg; }

/** main init: attempts to load PDF.js and then attach handlers */
async function initPdfFlow() {
  try {
    setStatus('Loading PDF library...');
    await loadScript(PDF_JS_PATH);
    // pdfjs may be exposed as window.pdfjsLib or window['pdfjs-dist/build/pdf']
    const pdfjs = window.pdfjsLib || window['pdfjs-dist/build/pdf'];
    if (!pdfjs) {
      throw new Error('pdfjs library loaded but global pdfjsLib not found. Confirm the file is the correct build (pdf.min.js).');
    }

    // set worker path (must be accessible via same-origin or allowed worker policy)
    pdfjs.GlobalWorkerOptions.workerSrc = PDF_WORKER_PATH;

    clearStatus();
    attachUIHandlers(pdfjs);
  } catch (err) {
    console.error('PDF.js loader error:', err);
    setError('PDF.js failed to load. Ensure files exist at: ' + PDF_JS_PATH + ' and ' + PDF_WORKER_PATH +
             '. Serve the site over HTTP (e.g. python -m http.server) and check the browser console / Network tab.');
    clearStatus();
  }
}

/** attach UI handlers — called after pdfjs is available */
function attachUIHandlers(pdfjs) {
  const uploadBox = document.getElementById('upload-box');
  const fileInput = document.getElementById('pdf-upload');

  // drag handlers (prevent defaults so drop works)
  ['dragenter','dragover'].forEach(evt => {
    uploadBox.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      uploadBox.classList.add('dragover');
    });
  });
  ['dragleave','drop'].forEach(evt => {
    uploadBox.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      uploadBox.classList.remove('dragover');
    });
  });

  uploadBox.addEventListener('drop', e => {
    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
      handleFile(pdfjs, e.dataTransfer.files[0]);
    }
  });

  // file input (label triggers native picker)
  fileInput.addEventListener('change', e => {
    if (e.target.files && e.target.files.length) handleFile(pdfjs, e.target.files[0]);
  });

  // accessibility: allow click on upload box to open file picker (optional)
  uploadBox.addEventListener('click', () => {
    try { fileInput.click(); } catch(_) { /* ignore */ }
  });

  // done attaching
  setStatus('');
}

/** process a File object with pdfjs and produce a PNG download link appended to uploadBox */
async function handleFile(pdfjs, file) {
  const uploadBox = document.getElementById('upload-box');
  const statusElLocal = document.getElementById('status');
  // basic file name check
  if (!file || !file.name || !file.name.toLowerCase().endsWith('.pdf')) {
    setError('Please provide a .pdf file.');
    return;
  }
  setError('');
  // clear old messages/links
  const oldMsg = uploadBox.querySelector('p.processing-msg'); if (oldMsg) oldMsg.remove();
  const oldLink = uploadBox.querySelector('a.download-link'); if (oldLink) oldLink.remove();

  const processing = document.createElement('p');
  processing.className = 'processing-msg';
  processing.textContent = 'Processing PDF...';
  uploadBox.appendChild(processing);

  try {
    const ab = await file.arrayBuffer();
    // getDocument will parse it, it uses worker if workerSrc set above
    const loadingTask = pdfjs.getDocument({ data: ab });
    const pdfDoc = await loadingTask.promise;
    console.log('PDF loaded, pages=', pdfDoc.numPages);
    // render first page
    const page = await pdfDoc.getPage(1);
    const viewport = page.getViewport({ scale: 2 });
    const canvas = document.createElement('canvas');
    canvas.width = Math.round(viewport.width);
    canvas.height = Math.round(viewport.height);
    const ctx = canvas.getContext('2d');

    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
    console.log('Rendered to canvas');
    const png = canvas.toDataURL('image/png');

    processing.remove();
    const a = document.createElement('a');
    a.className = 'download-link';
    a.href = png;
    a.download = file.name.replace(/\.pdf$/i, '.png');
    a.textContent = 'Download PNG';
    uploadBox.appendChild(a);

    // optionally show thumbnail above link
    const thumb = document.createElement('img');
    thumb.src = png;
    thumb.alt = 'Preview';
    thumb.style.maxWidth = '100%';
    thumb.style.marginTop = '12px';
    uploadBox.insertBefore(thumb, uploadBox.firstChild);

    setStatus('');
  } catch (err) {
    processing.textContent = 'Error processing PDF.';
    console.error('Processing error:', err);
    setError('Error processing PDF — check console for details.');
  }
}

// Bootstrap: attempt to load local pdf.min.js
document.addEventListener('DOMContentLoaded', () => {
  // Kick off dynamic load
  initPdfFlow();
});
</script>
</body>
</html>
